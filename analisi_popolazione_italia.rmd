---
title: "analisi popolazione italia v. 0.0.4"
author: "David Marabottini"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
version: 0.0.4
---

*Obiettivo*: Il seguente report analizza la struttura per età e l'impatto migratorio sulla popolazione residente in Italia nel 2025. Verranno confrontate piramidi di età su 3 tagli: residenti totali, residenti Stranieri e residenti Italiani

*Sorgente dei dati:* <https://demo.istat.it/> su "popolazione residente" e "popolazione straniera residente", per quanto riguarda la popolazione Italiana residente, è stato creato su excel come differenza tra le residenze totali e le residenze straniere

**I csv sono stati puliti, controllati e preelaborati con power query**

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

library(ggplot2)
library(tidyverse)
library(knitr)

```

```{r}
data_preparation_for_pyramid <- function(ds, maschi, femmine, group_years = 1, min_age=0, max_age=101) {
  
  ds_pivot = ds %>%
    select(Età, maschi, femmine) %>%
    filter(Età >= min_age & Età <= max_age) %>%
    pivot_longer(cols = c(maschi, femmine), names_to="Sesso", values_to="Popolazione" ) %>%
    
    mutate(Popolazione = ifelse(Sesso == maschi, -Popolazione, Popolazione)) %>%
    
    mutate(classe_eta = floor(Età/group_years)*group_years) %>%
    group_by(classe_eta, Sesso) %>%
    
    summarise(Popolazione_aggregata = sum(Popolazione)) %>%
    mutate(gruppo_eta = paste0(classe_eta, " - ", classe_eta + group_years - 1))
  
  return(ds_pivot)
}

generate_pyramid_chart <- function(pivot, title) {
  pop_max <- max(abs(pivot$Popolazione_aggregata), na.rm = TRUE)

  ggplot(pivot, aes(x = classe_eta, y = Popolazione_aggregata, fill = Sesso)) +
    
    geom_col() +
  
    coord_flip() +
    xlab("Maschi") +
    ylab("Femmine") +
  
    labs(
      title = title,
      x = "Età",
      y = "Popolazione",
      fill = "Sesso"
    ) +
    theme_minimal()
}

get_stats_base <- function(col) {
cat('varianza: ', var(col), '\n')
cat('deviazione standard: ', sd(col), '\n')
cat('distanza interquartile:', IQR(col), '\n')
cat('range: ', diff(range(col)), '\n')
}

population_old_idx <- function(population) {
  population %>%
    summarise(
      totale = sum(Totale),
      under_14 = sum(Totale[Età <= 14]),
      under_14_perc = under_14/totale*100,
      over_65  = sum(Totale[Età >= 65]),
      over_65_perc = over_65/totale*100
    )
}

calculate_quantiles <- function(x, freq, probs = c(0, 0.25, 0.5, 0.75, 1)) {
  # Controllo di base
  if (length(x) != length(freq)) {
    stop("Le lunghezze di x e freq non coincidono.")
  }

  # Rimuove valori con frequenza nulla (non servono per il calcolo)
  valid <- freq > 0
  x <- x[valid]
  freq <- freq[valid]

  # Ordina per età
  ord <- order(x)
  x <- x[ord]
  freq <- freq[ord]

  # Cumulative e totale
  cumfreq <- cumsum(freq)
  N = sum(freq)
  if (N == 0) stop("Tutte le frequenze sono zero!")

  # Calcolo dei quantili con interpolazione
  results = sapply(probs, function(p) {
    target = p * N
    i = which(cumfreq >= target)[1]
    if (is.na(i)) {
      stop(paste("Nessun indice trovato per il quantile", p))
    }
    if (i == 1) return(x[1])
    x0 = x[i - 1]
    x1 = x[i]
    f0 = cumfreq[i - 1]
    f1 = cumfreq[i]
    return(x0 + (x1 - x0) * (target - f0) / (f1 - f0))
  })

  return(results)
}

preliminary_checks <- function(residents, title) {
  # ---- Stampo il boxplot ----
  par(mfrow = c(1, 3), oma = c(0, 0, 3, 0))
  
  males = boxplot(residents$maschi, main = "Maschi", ylab = "Numero di Residenti")
  females = boxplot(residents$femmine, main = "Femmine", ylab = "")
  total = boxplot(residents$Totale, main = "Totale", ylab = "")
  
    # ---- Quartili ----
  print("Maschi")
  print("Quartili")
  quart_maschi = calculate_quantiles(residents$Età, residents$maschi)
  print(quart_maschi)
  cat("Distanza interqurtile: ", quart_maschi[4] - quart_maschi[2], "\n")
  cat("Range: ", quart_maschi[5] - quart_maschi[1], "\n")
  
  print("Femmine")
  print("Quartili")
  quart_femmine = calculate_quantiles(residents$Età, residents$femmine)
  print(quart_femmine)
  cat("Distanza interqurtile: ", quart_femmine[4] - quart_femmine[2], "\n")
  cat("Range: ", quart_femmine[5] - quart_femmine[1], "\n")
  
    print("Totale")
  print("Quartili")
  quart_tot = calculate_quantiles(residents$Età, residents$Totale)
  print(quart_tot)
  cat("Distanza interqurtile: ", quart_tot[4] - quart_tot[2], "\n")
  cat("Range: ", quart_tot[5] - quart_tot[1], "\n")
  
  mtext(title, outer = TRUE, cex = 1.2, font = 2, line = 0.5)
  
  par(mfrow = c(1, 1), oma = c(0, 0, 0, 0))
  
  # ---- Calcolo le medie ----
  
  n_maschi = sum(residents$maschi)
  n_femmine = sum(residents$femmine)
  n_totale = sum(residents$Totale)
  
  media_maschi = sum(residents$Età * residents$maschi)/n_maschi
  media_femmine = sum(residents$Età * residents$femmine)/n_femmine
  media_totale = sum(residents$Età * residents$Totale)/n_totale
  
  # ---- Varianze ----
  var_maschi  = sum(residents$maschi  * (residents$Età - media_maschi)^2) / n_maschi
  var_femmine = sum(residents$femmine * (residents$Età - media_femmine)^2) / n_femmine
  var_totale  = sum(residents$Totale  * (residents$Età - media_totale)^2) / n_totale

  # ---- Calcolo gli outliers ----
  
    risultati_df <- data.frame(
    Statistica = c("Media Età", "Varianza", "Deviazione standard", "N° Outlier"),
    Maschi  = c(media_maschi, var_maschi, sqrt(var_maschi), length(males$out)),
    Femmine = c(media_femmine, var_femmine, sqrt(var_femmine), length(females$out)),
    Totale  = c(media_totale, var_totale, sqrt(var_femmine), length(total$out))
  )
  
  # ---- Tabella formattata ----
  kable(risultati_df, digits = 2, caption = paste("Statistiche per", title))
}
```

```{r}
resident_italy = read.csv('source/Popolazione_residente_italia_ISTAT_2025.csv', sep=";")
strangers_resident_italy = read.csv('source/Popolazione straniera residente_istat_2025.csv', sep=";")
italians_resident_italy = read.csv('source/Popolazione_italiana_residente_italia_ISTAT_2025.csv', sep=";")
```

## Analisi integrità dei dati

### Verifica degli outliers

```{r}
preliminary_checks(resident_italy, "Distribuzione dei Residenti in Italia per Sesso (Boxplot)")
```

```{r}
preliminary_checks(strangers_resident_italy, "Distribuzione dei Residenti stranieri in Italia per Sesso (Boxplot)")
```

La maggior parte dei residenti stranieri sembra concentrata nella fascia di età tra 20 e 50 anni, con una distanza interquartile per gli uomini di 25 anni e per le donne di 27. Sembra che le donne siano più anziane degli uomini, con una mediana che sta a 39 anni, contro i 34 degli uomini.

L'età media risulta abbastanza allineata alla mediana, con 34 anni per gli uomini e 38 per le donne.

L'allineamento di media e mediana, la deviazione standard (18, 19) e distanza interquartile basse rispetto al range (100) rendono media e mediana buoni indicatori per l'età dello straniero medio

```{r}
preliminary_checks(italians_resident_italy, "Distribuzione dei Residenti Italiani in Italia per Sesso (Boxplot)")
```

La maggior parte dei residenti Italiani sembra concentrata nella fascia di età tra 27 e 65 anni, con una distanza interquartile di 37 anni. Sembra che le donne siano più anziane degli uomini, pur avendo di fatto la stessa distanza interquartile, come se questa fosse lievemente traslata

L'età media e la mediana sono distanti di 2 anni sia per gli uomini (46 - 48) che per le donne (49 - 51) mentre la deviazione standard risulta a 23 per gli uomini e 24 per le donne

Qui la situazione anagrafica risulta più eterogenea, anche se mediamente con una fascia più alta dell'età

## Analisi sulla popolazione residente in Italia

```{r}
pivoted_datas = data_preparation_for_pyramid(resident_italy, "maschi", "femmine")

generate_pyramid_chart(pivoted_datas, title="Piramide dell'età popolazione totale residente in Italia")

```

**Età media**

```{r}
eta_media_totale <- weighted.mean(resident_italy$Età, resident_italy$Totale)
eta_media_totale

```

**Dati vecchiaia**

```{r}
italy_resident_trasholds = population_old_idx(resident_italy)
```

```{r}
italy_resident_trasholds
```

```{r}
cat("Indice vecchiaia: ", (italy_resident_trasholds[['over_65']]/italy_resident_trasholds[['under_14']])*100)

```

L'età media è di 46 anni mentre l'indice di vecchiaia è a 207.

Un indice sopra i 100 vuol dire che gli over 65 sono molti di più rispetto agli under 14, un indice a 207 indica che questi sono più del doppio, ciò contribuisce ad alzare significativamente l'età media

------------------------------------------------------------------------

## Analisi sulla popolazione Straniera residente in Italia

```{r}
pivoted_stranges = data_preparation_for_pyramid(strangers_resident_italy, "maschi", "femmine" )
generate_pyramid_chart(pivoted_stranges, title="Piramide dell'età stranieri residenti in Italia")
```

La piramide degli stranieri residenti presenta una forma differente, con un picco tra i 25 e 40 anni, e una drastica diminuzione oltre i 40. Inoltre, la popolazione sotto i 20 anni sembra più stabile rispetto alla piramide della popolazione totale, anche se riflette anch'essa una lieve decrescita. Questo mostra che l'immigrazione ha un ruolo importante nell'alleviare il peso dell'inverno demografico che abbiamo davanti

**Età media**

```{r}
eta_media_stranieri <- weighted.mean(strangers_resident_italy$Età, strangers_resident_italy$Totale)
eta_media_stranieri
```

**dati vecchiaia**

```{r}
italy_strangers_resident_trasholds = population_old_idx(strangers_resident_italy)

italy_strangers_resident_trasholds

```

```{r}
cat("Indice vecchiaia: ", (italy_strangers_resident_trasholds[['over_65']]/italy_strangers_resident_trasholds[['under_14']])*100)
```

L'età media per i soli Stranieri è a 36 anni circa mentre l'indice è a 39.45.

Questo indica che tra gli stranieri gli under 14 sono più del doppio degli over 65

------------------------------------------------------------------------

## Analisi sulla popolazione Italiana residente in Italia

```{r}
pivoted_italians = data_preparation_for_pyramid(italians_resident_italy, "maschi", "femmine" )
generate_pyramid_chart(pivoted_italians, title="Piramide dell'età Italiani residenti in Italia")
```

Filtrando solo gli Italiani, la piramide conferma la forte decrescita nelle classi di età più giovane. L'assenza della componente straniera mostra ancor di più l'inverno demografico che si sta configurando in Italia

```{r}
italy_citizen_resident_trasholds = population_old_idx(italians_resident_italy)

```

**Età media**

```{r}
eta_media_italiani <- weighted.mean(italians_resident_italy$Età, italians_resident_italy$Totale)
eta_media_italiani
```

**dati vecchiaia**

```{r}
italy_citizen_resident_trasholds
```

```{r}
cat("Indice vecchiaia: ", (italy_citizen_resident_trasholds[['over_65']]/italy_citizen_resident_trasholds[['under_14']])*100)
```

L'età media è a 47 mentre l'indice di vecchiaia (non mitigato) è a 231, che vuol dire un peggioramento importante della situazione rispetto ai dati presi su tutta la popolazione residente

------------------------------------------------------------------------

## Percentuale della popolazione Straniera in Italia ripartita per età

```{r}
residents_nationality = read.csv('source/Popolazione residente per cittadinanza o paese di nascita_istat_2025.csv')
```

```{r}
resident_reordered = residents_nationality %>%
  arrange(desc(Totale)) %>%
  filter(Cittadinanza != 'Totale')
```

```{r}
perc_strangers = strangers_resident_italy %>%
  select('Età', Totale) %>%
  mutate(Totale = Totale/resident_italy$Totale)

```

```{r}
#percentuale stranieri su totale popolazione
plot(perc_strangers$Età, perc_strangers$Totale*100, main="Percentuale stranieri sulla popolazione  residente in Italalia per Età", xlab = "Età", ylab="Popolazione straniera (%)")
polygon(
  x = c(15, perc_strangers$Età[perc_strangers$Età >= 15 & perc_strangers$Età <= 63], 63),
  y = c(0, perc_strangers$Totale[perc_strangers$Età >= 15 & perc_strangers$Età <= 63] * 100, 0),
  col = rgb(0.1, 0.5, 0.8, 0.2),
  border = NA
)
```

In questo grafico mostro la percentuale di stranieri rispetto alla popolazione.

Ho evidenziato la fascia 15, 64 anni in quanto è la fascia lavorativa.

è evidente che la quantità di stranieri supera la soglia del 10% tra le fasce giovani

------------------------------------------------------------------------

## Ulteriori informazioni

```{r}
cat('Ci sono ',length(residents_nationality$Cittadinanza), 'Cittadinanze in Italia\n')
cat('Di seguito le prime 5 per numero di persone')

resident_reordered %>%
  select('Anno', 'Cittadinanza', 'Totale') %>%
  mutate(Totale = formatC(Totale*100/sum(resident_reordered$Totale), format="f", digits=2)) %>%
  slice_head(n = 5)
```

------------------------------------------------------------------------

## Conclusioni

La percentuale di stranieri in età lavorativa nel paese è in crescita, aiutandoci sia ad alleviare i sintomi dell'inverno demografico di cui l'Italia soffre, sia probabilmete a garantire un apporto importante di forza lavoro, tasse e a reggere il sistema pensionistico.

Sarebbe interessante incrociare questi dati con dati economici per avere conferme o smentite circa il beneficio apportato nella situazione economica Italiana.
