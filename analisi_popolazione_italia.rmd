---
title: "analisi popolazione italia"
author: "David Marabottini"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r}
# install.packages("tinytex")
# tinytex::install_tinytex(force = TRUE)
library(ggplot2)
library(tidyverse)
```

```{r}
data_preparation_for_pyramid <- function(ds, maschi, femmine, group_years = 1, min_age=0, max_age=101) {
  
  ds_pivot = ds %>%
    select(Età, maschi, femmine) %>%
    filter(Età >= min_age & Età <= max_age) %>%
    pivot_longer(cols = c(maschi, femmine), names_to="Sesso", values_to="Popolazione" ) %>%
    
    mutate(Popolazione = ifelse(Sesso == maschi, -Popolazione, Popolazione)) %>%
    
    mutate(classe_eta = floor(Età/group_years)*group_years) %>%
    group_by(classe_eta, Sesso) %>%
    
    summarise(Popolazione_aggregata = sum(Popolazione)) %>%
    mutate(gruppo_eta = paste0(classe_eta, " - ", classe_eta + group_years - 1))
  
  return(ds_pivot)
}

generate_pyramid_chart <- function(pivot, title) {
  pop_max <- max(abs(pivot$Popolazione_aggregata), na.rm = TRUE)

  ggplot(pivot, aes(x = classe_eta, y = Popolazione_aggregata, fill = Sesso)) +
    
    geom_col() +
  
    coord_flip() +
    xlab("Maschi") +
    ylab("Femmine") +
  
    labs(
      title = title,
      x = "Età",
      y = "Popolazione",
      fill = "Sesso"
    ) +
    theme_minimal()
}
```

```{r}
resident_italy = read.csv('source/Popolazione_residente_italia_ISTAT_2025.csv', sep=";")
strangers_resident_italy = read.csv('source/Popolazione straniera residente_istat_2025.csv', sep=";")

# print(resident_italy)
# print(strangers_resident_italy)

```


```{r}
pivoted_datas = data_preparation_for_pyramid(resident_italy, "maschi", "femmine")

generate_pyramid_chart(pivoted_datas, title="Piramide dell'età popolazione totale residente in Italia")
```

La piramide della popolazione Italiana sembra toccare i suoi massimi ilvelli tra i 40 e i 65 anni e la tendenza sembra in decrescita al diminuire dell'età

```{r}
pivoted_stranges = data_preparation_for_pyramid(strangers_resident_italy, "maschi", "femmine" )
generate_pyramid_chart(pivoted_stranges, title="Piramide dell'età stranieri residenti in Italia")
```

La popolazione straniera sembra avere il massimo tra i 25 e i 40 anni , anche essa risulta in diminuzione all'abbassarsi dell'età, anche se più stabile

Calcolo la percentuale di stranieri in base all'età

```{r}
perc_strangers = strangers_resident_italy %>%
  select('Età', Totale) %>%
  mutate(Totale = Totale/resident_italy$Totale)
```

```{r}
names(pivoted_stranges)

length(pivoted_datas$Popolazione_aggregata)
length(pivoted_stranges$Popolazione_aggregata)

pivoted_italians <- pivoted_datas
pivoted_italians$Popolazione_aggregata <-
  pivoted_datas$Popolazione_aggregata - pivoted_stranges$Popolazione_aggregata

generate_pyramid_chart(pivoted_italians, title="Piramide dell'età di cittadini Italiani residenti in Italia")
```

```{r}
length(pivoted_stranges$Popolazione_aggregata)
```

```{r}
#percentuale stranieri rispetto agli italiani
plot(perc_strangers$Età, perc_strangers$Totale*100, main="Percentuale stranieri sulla popolazione  residente in Italalia per Età", xlab = "Età", ylab="Popolazione straniera (%)")
polygon(
  x = c(15, perc_strangers$Età[perc_strangers$Età >= 15 & perc_strangers$Età <= 74], 74),
  y = c(0, perc_strangers$Totale[perc_strangers$Età >= 15 & perc_strangers$Età <= 74] * 100, 0),
  col = rgb(0.1, 0.5, 0.8, 0.2),
  border = NA
)
```

```{r}
media_15_65 <- mean(perc_strangers$Totale[perc_strangers$Età >= 15 & perc_strangers$Età <= 65])

media_15_65*100
```

```{r}
residents_nationality = read.csv('source/Popolazione residente per cittadinanza o paese di nascita_istat_2025.csv')
```

```{r}
resident_reordered = residents_nationality %>%
  arrange(desc(Totale)) %>%
  filter(Cittadinanza != 'Totale')
```

Valori relativi

```{r}
cat('Ci sono ',length(residents_nationality$Cittadinanza), 'Cittadinanze in Italia\n')
cat('Di seguito le prime 5 per numero di persone')

resident_reordered %>%
  select('Anno', 'Cittadinanza', 'Totale') %>%
  mutate(Totale = formatC(Totale*100/sum(resident_reordered$Totale), format="f", digits=2)) %>%
  slice_head(n = 5)
```

```{r}
eta_media_totale <- weighted.mean(resident_italy$Età, resident_italy$Totale)
eta_media_totale

```

```{r}
eta_media_totale <- weighted.mean(strangers_resident_italy$Età, strangers_resident_italy$Totale)
eta_media_totale
```

L'età media di tutta la popolazione totale è di 46 anni, l'età media degli stranieri è di 36, 10 anni, ciò però vuol dire che l'età media dei soli Italiani si può trovare dall'equazione x*0.91+36*0.09=46, ovvero (46-36\*0.09)/0.91 = 46.98 ovvero 47 anni.

C'è un divario di età media di 10 anni tra Italiani e Stranieri

Tutti questi dati implica che l'immigrazione straniera in Italia contribuisce significativamente ad abbassare l'età media della popolazione e alleviare il peso dell'inverno demografico che stiamo vivendo
